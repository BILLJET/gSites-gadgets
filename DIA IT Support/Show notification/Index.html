<!--    /* =================================================== */
        /*          DIA IT SUPPORT- Show notification          */
        /* =================================================== */
        /*                                                     */
        /*   Â© 2018 Piotr Biller                               */
        /*                                                     */
        /*   piotr.biller@contractors.roche.com                */
        /*   piotr.biller@billennium.pl                        */
        /*                                                     */
        /* =================================================== */   -->
<!DOCTYPE html>
<html>

<head>
    <title> Major Incident Notification</title>
    <?!= include("style.css"); ?>
</head>

<body>
    <div id="tabs-main" class="container mainContentPanel">
        <div class="content" id="showPost"></div>
    </div>
    <?!= include("jQuery_3.2.1.js"); ?>
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</body>

</html>
<script>
    var records = [];
    var actual = [];
    var archived = [];
    var showArchivedPostsListWithId;
    var array = [];
    var isArchiving = false;

    $(document).ready(function () {
        displayData();
    });

    function displayData() {
        loadApp();
    }

    function getAllRecordsFromSpreadSheet() {
        <? var recordsFromSheet = getAllRecordsFromSheet(); ?>
        <? for (var i = 0; i < recordsFromSheet.length; i++) {  ?>
            records.push([
                <?= recordsFromSheet[i].date; ?>,
                <?= recordsFromSheet[i].author; ?> ,
                <?= recordsFromSheet[i].subject; ?>,
                <?= recordsFromSheet[i].content; ?>,
                <?= recordsFromSheet[i].id; ?>,
                <?= recordsFromSheet[i].archived; ?>,
                <?= recordsFromSheet[i].type; ?>
            ]);
        <? } ?>
    }

    function loadApp() {
        getAllRecords();
        automaticallyArchiving();
        if (isArchiving) {
            records = [];
            actual = [];
            archived = [];
            getAllRecords();
            showNewestPostsList();
        }
        else if (!isArchiving) {
            showNewestPostsList();
        }
    }

    function automaticallyArchiving() {
        var nowDate = new Date();
        var currentTime = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate(), 0, 0, 0, 0).getTime();
        var weekTime = 604800000;
        var archivingTime = currentTime - weekTime;
        var checkedTime;

        for (i = 0; i < actual.length; i++) {
            if (actual[i][6] === 'resolved' || actual[i][6] === 'blank') {
                checkedTime = new Date(actual[i][0]).getTime();
                if (checkedTime < archivingTime) {
                    addToArchive(actual[i][4], records.length);
                    isArchiving = true;
                }
            }
        }
    }

    function addToArchive(item, recordsLength) {
        google.script.run.addItemToArchive(item, recordsLength);
    }

    function getAllRecords() {
        getAllRecordsFromSpreadSheet();
        records.reverse();
        for (var i = 0; i < records.length; i++) {
            if (records[i][5] === 'No') {
                actual.push([
                    records[i][0],
                    records[i][1],
                    records[i][2],
                    records[i][3],
                    records[i][4],
                    records[i][5],
                    records[i][6]
                ]);
            }
            else if (records[i][5] === 'Yes') {
                archived.push([
                    records[i][0],
                    records[i][1],
                    records[i][2],
                    records[i][3],
                    records[i][4],
                    records[i][5],
                    records[i][6]
                ]);
            }
        };
        archived.sort(function (el1, el2) {
            return el1[4] - el2[4];
        });
        archived.reverse();
    }

    function createPostsList(record) {
        var html =
            '<div style="padding: 15px 0 55px 0;border-bottom:solid 1px #e5e5e5"><div style="float:left;width:86%;"><div><a onclick="showNewestPostDetails(\'' + record[0] + '\',\'' + record[1] + '\',\'' + record[2] + '\',\'' + record[3] + '\')" style="font-size:15px;color:#0066cc;font-weight:bold;cursor:pointer;">' + record[1] + '</a><div style="color:black;font-size:10px;margin-top:5px;"><span>Posted </span><span style="font-weight:bold;"> ' + record[0] + '</span><span> by </span><span style="font-weight:bold;">' + record[2] + '</span></div></div></div></div>';
        return html;
    }

    function createArchivedList(record) {
        var methodName;
        var showPost;

        if (record[6] == 'declaration' || record[6] == 'blank') {
            if (record[6] == 'declaration') {
                methodName = 'showArchivedListAfterID(\'' + record[4] + '\')';
            }
            else if (record[6] == 'blank') {
                methodName = 'showArchivedPostDetails(\'' + record[0] + '\',\'' + record[1] + '\',\'' + record[2] + '\',\'' + record[3] + '\')';
            }

            var showArchived = '<div style="float:right;"><div style="width:88px;border:1px solid #FF7F00;border-radius:6px;text-align:center;background:#FF7F00;font-size:13px;padding:5px 2px;">Archived</div>';
            showPost = '<div style="padding: 15px 0 37px 0;border-bottom:solid 1px #e5e5e5"><div style="float:left;width:86%;"><div><a onclick="' + methodName + '" style="font-size:15px;color:#0066cc;font-weight:bold;cursor:pointer;">IM ' + record[4] + ' - ' + record[1] + '</a></div></div>' + showArchived + '</div></div>';
        }
        var html = showPost;

        return html;
    }

    function showNewestPostDetails(date, subject, author, content, id, archived) {
        $("#showPost").html('<div style="margin-bottom:35px;"><span style="font-size:15px;color:#0066cc;font-weight:bold;margin-bottom:20px;"><a>' + subject + '</a></span></div><div style="min-height:200px;margin-bottom:50px;"><div style="margin:15px;"><div style="font-size:13px;">' + content + '</div></div></div><div style="font-size:12px;"><span>Create by: </span><span style="font-weight:bold;">' + author + '</span><span>  date: </span><span style="font-weight:bold;">' + date + '</span></div><div style="margin-top:10px;"><button type="button" onClick="showNewestPostsList()" style="float:left;width:90px;height:25px;border:1px solid #0066cc;background:#0066cc;color:white;border-radius:5px;cursor:pointer;">Back</button></div>');
    }

    function showArchivedPostDetails(date, subject, author, content, id, archived) {
        $("#showPost").html('<div style="margin-bottom:35px;"><span style="font-size:15px;color:#0066cc;font-weight:bold;margin-bottom:20px;"><a>' + subject + '</a></span><span style="border:1px solid #FF7F00;border-radius:6px;text-align:center;background:#FF7F00;font-size:13px;margin-left:10px;padding:1px 15px;">Archived</span></div><div style="min-height:200px;margin-bottom:50px;"><div style="margin:15px;"><div style="font-size:13px;">' + content + '</div></div></div><div style="font-size:12px;"><span>Create by: </span><span style="font-weight:bold;">' + author + '</span><span>  date: </span><span style="font-weight:bold;">' + date + '</span></div><div style="margin-top:10px;"><button type="button" onClick="showNewestPostsList()" style="float:left;width:90px;height:25px;border:1px solid #0066cc;background:#0066cc;color:white;border-radius:5px;cursor:pointer;margin-right:8px;">Back</button><button type="button" onClick="showArchivedPostsList()" style="float:left;width:90px;height:25px;border:1px solid #FF7F00;background:#FF7F00;color:white;border-radius:5px;cursor:pointer;">Back</button></div>');
    }

    function createArchivedListAfterID(record) {
        var showArchived = '';
        var showId = '';
        var methodName;
        var showList;

        methodName = 'showArchivedPostDetails';
        showId = '<span style="font-size:13px;font-weight:bold;margin-left:5px;">ID.' + record[4] + '</span>';
        showArchived = '<div style="float:right;"><div style="width:88px;border:1px solid #FF7F00;border-radius:6px;text-align:center;background:#FF7F00;font-size:13px;padding:5px 2px;">Archived</div>';
        showList = '<div style="padding: 15px 0 55px 0;border-bottom:solid 1px #e5e5e5"><div style="float:left;width:86%;"><div><a onclick="' + methodName + '(\'' + record[0] + '\',\'' + record[1] + '\',\'' + record[2] + '\',\'' + record[3] + '\')" style="font-size:15px;color:#0066cc;font-weight:bold;cursor:pointer;">' + record[1] + '</a>' + showId + '</div><div style="color:black;font-size:10px;margin-top:5px;"><span>Posted </span><span style="font-weight:bold;"> ' + record[0] + '</span><span> by </span><span style="font-weight:bold;">' + record[2] + '</span></div></div>' + showArchived + '</div></div>';

        var html = showList;
        return html;
    }

    function showArchivedListAfterID(postID) {
        showArchivedPostsListWithId = postID;
        $("#showPost").html("");
        $("#showPost").html(showMultipleButton());

        for (var i = 0; i < archived.length; i++) {
            if (archived[i][4] == postID) {
                $("#showPost").append(createArchivedListAfterID(archived[i]));
            }
        };
    }

    function showArchiveButton(buttonName) {
        var html =
            '<div style="padding: 8px 0 28px 0;"><div style="float:right;"><div style=""><a style="width:180px;border:1px solid #FF7F00;border-radius:6px;text-align:center;background:#FF7F00;font-size:14px;cursor:pointer;padding:6px 47px;" onclick="showArchivedPostsList()">' + buttonName + '</a></div></div>';
        return html;
    }
    function showBackButton() {
        var html =
            '<div style="padding: 8px 0 28px 0;"><div style="float:right;"><div style=""><a style="border:1px solid #0066cc;border-radius:6px;text-align:center;background:#0066cc;font-size:14px;cursor:pointer;padding:6px 41px;color:white;" onclick="showNewestPostsList()">Back</a></div></div>';
        return html;
    }

    function showMultipleButton() {
        $("#showPost").html('<div style="padding: 8px 0 28px 0;"><div style="float:right;"><div style=""><a style="width:180px;border:1px solid #FF7F00;border-radius:6px;text-align:center;background:#FF7F00;font-size:14px;cursor:pointer;padding:6px 47px;" onclick="showArchivedPostsList()">Back</a></div></div><div style="padding: 0px 0 28px 0;"><div style="float:right;"><div style=""><a style="border:1px solid #0066cc;border-radius:6px;text-align:center;background:#0066cc;font-size:14px;cursor:pointer;padding:6px 41px;color:white;margin-right: 8px;" onclick="showNewestPostsList()">Back</a></div></div>');
    }

    function showNewestPostsList() {
        $("#showPost").html("");
        if (archived.length > 0) {
            $("#showPost").html(showArchiveButton('Archive'));
        }
        if (actual.length == 0) {
            $("#showPost").append('<div style="background: #0066cc;color: white;text-align: center;width: 270px;padding: 6px;border: 1px solid #0066cc;border-radius: 7px;margin-left: auto;margin-right: auto;margin-top: 70px;">No new posts to display</div>');
        }
        else if (actual.length > 0) {
            for (var i = 0; i < actual.length; i++) {
                $("#showPost").append(createPostsList(actual[i]));
            };
        }
    }

    function showArchivedPostsList() {
        array = [];
        $("#showPost").html(showBackButton());
        for (var i = 0; i < archived.length; i++) {
            $("#showPost").append(createArchivedList(archived[i]));
        };
    }
</script>
